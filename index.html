<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HAKA Group IT - Management Portal</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        :root { --primary: linear-gradient(135deg, #166e48 0%, #0d4d32 100%); --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; overflow: hidden; color: #333; }
        #login-page { display: flex; justify-content: center; align-items: center; height: 100vh; position: fixed; width: 100%; background: var(--bg); z-index: 10000; }
        .login-card { background: #fff; padding: 40px; border-radius: 30px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); width: 350px; text-align: center; }
        #admin-dashboard { display: none; height: 100vh; width: 100%; display: flex; }
        .sidebar { width: 260px; background: #fff; border-right: 1px solid #e0e6e4; display: flex; flex-direction: column; padding: 25px; box-sizing: border-box; }
        .main { flex: 1; padding: 25px; overflow-y: auto; box-sizing: border-box; }
        .nav-item { padding: 12px 15px; margin-bottom: 5px; border-radius: 12px; cursor: pointer; display: flex; align-items: center; gap: 10px; color: #5a6b65; transition: 0.3s; font-weight: 500; }
        .nav-item.active { background: var(--primary); color: #fff; }
        .page-content { display: none; }
        .page-content.active { display: block; }
        .chart-card { background: #fff; padding: 15px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); margin-bottom: 20px; height: 200px; }
        table { width: 100%; border-collapse: collapse; background: #fff; border-radius: 15px; overflow: hidden; }
        th { background: #f8faf9; padding: 12px; text-align: left; color: #889; font-size: 11px; text-transform: uppercase; }
        td { padding: 12px; border-bottom: 1px solid #f1f3f2; font-size: 13px; }
        .modal { display:none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(13, 38, 28, 0.6); z-index:20000; backdrop-filter: blur(8px); }
        .modal-content { background: #fff; margin: 2% auto; width: 750px; border-radius: 25px; overflow: hidden; }
        .modal-header { background: var(--primary); color: white; padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 25px; max-height: 75vh; overflow-y: auto; }
        .hist-card { background: #fff; padding: 20px; border-radius: 15px; margin-bottom: 20px; border-left: 6px solid #166e48; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .box-problem { background: #fff8e1; color: #856404; padding: 15px; border-radius: 10px; margin-top: 10px; font-size: 13px; border: 1px solid #ffeeba; }
        .box-solution { background: #e8f5e9; color: #1b5e20; padding: 15px; border-radius: 10px; margin-top: 10px; font-size: 13px; border: 1px solid #c8e6c9; }
        .img-preview { background: #f9f9f9; border-radius: 10px; padding: 10px; text-align: center; margin-top: 15px; border: 1px dashed #ddd; }
        .img-preview img { max-width: 100%; border-radius: 8px; max-height: 300px; cursor: pointer; }
        input, select, textarea { width: 100%; padding: 12px; margin-top: 5px; border-radius: 10px; border: 1.5px solid #e0e6e4; box-sizing: border-box; }
        .btn-act { background: var(--primary); color: white; border: none; padding: 10px 18px; border-radius: 10px; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; }
        .btn-del { background: #ffebee; color: #d32f2f; border: none; padding: 6px 12px; border-radius: 8px; cursor: pointer; font-size: 11px; }
    </style>
</head>
<body>

    <div id="login-page">
        <div class="login-card">
            <img src="https://i.postimg.cc/Y98Km4rh/Whats-App-Image-2026-01-22-at-14-13-49.png" width="160">
            <h3>IT Staff Portal</h3>
            <input type="email" id="userEmail" placeholder="Email">
            <input type="password" id="userPass" placeholder="Password">
            <button onclick="handleLogin()" class="btn-act" style="width:100%; margin-top:20px; justify-content:center;">Sign In</button>
        </div>
    </div>

    <div id="admin-dashboard">
        <div class="sidebar">
            <img src="https://i.postimg.cc/Y98Km4rh/Whats-App-Image-2026-01-22-at-14-13-49.png" width="130" style="align-self:center; margin-bottom:35px;">
            <div class="nav-item" id="nav-dashboard" onclick="showPage('dashboard')"><span class="material-icons-outlined">dashboard</span> Dashboard</div>
            <div class="nav-item" id="nav-progress" onclick="showPage('progress')"><span class="material-icons-outlined">trending_up</span> Your Progress</div>
            <div id="super-menu" style="display:none; border-top:1px solid #eee; margin-top:10px; padding-top:10px;">
                <div class="nav-item" id="nav-team" onclick="showPage('team')"><span class="material-icons-outlined">groups</span> Team Monitoring</div>
                <div class="nav-item" id="nav-security" onclick="showPage('security')"><span class="material-icons-outlined">admin_panel_settings</span> Security & Admins</div>
            </div>
            <div onclick="logout()" style="margin-top:auto; color:red; cursor:pointer; padding:10px; display:flex; align-items:center; gap:10px; font-weight:600;"><span class="material-icons-outlined">logout</span> Logout</div>
        </div>

        <div class="main">
            <h3 style="margin-bottom:25px;">Hello, <span id="adminDisplayName" style="color:#166e48;">User</span></h3>

            <div id="dashboard-page" class="page-content">
                <div class="chart-card"><canvas id="companyChart"></canvas></div>
                <table>
                    <thead><tr><th>ID</th><th>Company</th><th>Summary</th><th>Action</th></tr></thead>
                    <tbody id="ticketBody"></tbody>
                </table>
            </div>

            <div id="progress-page" class="page-content">
                <div style="background:#fff; padding:15px; border-radius:15px; border-left:5px solid #166e48; margin-bottom:15px;">
                    Total Solved by You: <b id="count-my-progress">0</b>
                </div>
                <table>
                    <thead><tr><th>ID</th><th>Company</th><th>Resolution Note</th></tr></thead>
                    <tbody id="myHistoryBody"></tbody>
                </table>
            </div>

            <div id="team-page" class="page-content">
                <div style="display: flex; gap: 15px; margin-bottom: 20px; align-items: center; justify-content: space-between;">
                    <h4 style="margin:0;">Team Performance & Reporting</h4>
                    <div id="export-controls" style="display: flex; gap: 10px;">
                        <button onclick="exportToExcel()" class="btn-act" style="background:#2e7d32; font-size:12px;">
                            <span class="material-icons-outlined">table_view</span> Excel Report
                        </button>
                        <button onclick="exportToPDF()" class="btn-act" style="background:#c62828; font-size:12px;">
                            <span class="material-icons-outlined">picture_as_pdf</span> PDF Report
                        </button>
                    </div>
                </div>
                <div class="chart-card"><canvas id="teamChart"></canvas></div>
                <table>
                    <thead><tr><th>Admin Name</th><th>Email</th><th>Solved</th><th>Action</th></tr></thead>
                    <tbody id="teamBody"></tbody>
                </table>
            </div>

            <div id="security-page" class="page-content">
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
                    <div style="background:#fff; padding:25px; border-radius:20px;">
                        <h4>Update My Security</h4>
                        <input type="email" id="h-email" placeholder="Current Email">
                        <input type="password" id="h-old-pass" placeholder="Current Password">
                        <input type="password" id="h-new-pass" placeholder="New Password">
                        <button onclick="handleHandover()" class="btn-act" style="width:100%; margin-top:15px; justify-content:center;">Save & Logout</button>
                    </div>
                    <div style="background:#fff; padding:25px; border-radius:20px;">
                        <h4>Register New Admin</h4>
                        <input type="text" id="add-name" placeholder="Full Name">
                        <input type="email" id="add-email" placeholder="Work Email">
                        <input type="password" id="add-pass" placeholder="Password">
                        <select id="add-role"><option value="admin">Admin</option><option value="superadmin">Super Admin</option></select>
                        <button onclick="addNewAdmin()" class="btn-act" style="width:100%; margin-top:15px; background:#000; justify-content:center;">Add Admin</button>
                    </div>
                </div>

                <div style="background:#fff; padding:25px; border-radius:20px; margin-top:20px;">
                    <h4 style="margin-top:0; color:#166e48;">Active Admins Management</h4>
                    <table>
                        <thead>
                            <tr><th>Name</th><th>Email</th><th>Role</th><th>Action</th></tr>
                        </thead>
                        <tbody id="activeAdminsBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="solveModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3>Process Ticket</h3><span class="material-icons-outlined" onclick="closeModal()" style="cursor:pointer;">close</span></div>
            <div class="modal-body">
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; background:#f9f9f9; padding:15px; border-radius:12px;">
                    <div><label style="font-size:10px; color:#888;">TICKET ID</label><div id="det-id" style="font-weight:600;"></div></div>
                    <div><label style="font-size:10px; color:#888;">EMPLOYEE</label><div id="det-name" style="font-weight:600;"></div></div>
                </div>
                <div id="det-desc" class="box-problem"></div>
                <div id="det-attach" class="img-preview"></div>
                
                <hr style="margin:20px 0; border:0; border-top:1px solid #eee;">
                <input type="hidden" id="activeRecId">
                <select id="newStatus"><option value="Done">Resolved</option><option value="Incomplete">Needs Info</option></select>
                <textarea id="resDesc" rows="3" placeholder="Explain the technical resolution..." style="margin-top:10px;"></textarea>
                <button onclick="submitResolution()" class="btn-act" style="width:100%; margin-top:15px; justify-content:center; padding:15px;">Submit Resolution</button>
            </div>
        </div>
    </div>

    <div id="historyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3 id="hist-title">History</h3><span class="material-icons-outlined" onclick="closeModal()" style="cursor:pointer;">close</span></div>
            <div class="modal-body" id="hist-list"></div>
        </div>
    </div>

<script>
    const T = "patSfE4E7BGq95o5V.765ef3c9e82a7fb6fe26152bd2e696c5224ebb2cd0593b1a955b38f9eaf2cad0", B = "appyQQt9Dg0MP0zVK", U = "users", L = "it system 2";
    let charts = {}, globalTickets = [];

    window.onload = () => { 
        const saved = localStorage.getItem('hakaUser'); 
        if(saved) {
            setupDashboard(JSON.parse(saved));
            showPage(sessionStorage.getItem('lastPage') || 'dashboard');
        }
    };

    function showPage(pId) {
        document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById(pId + '-page').classList.add('active');
        document.getElementById('nav-' + pId).classList.add('active');
        sessionStorage.setItem('lastPage', pId);
    }

    async function handleLogin() {
        const e = document.getElementById('userEmail').value, p = document.getElementById('userPass').value;
        const q = encodeURIComponent(`AND({Email}='${e}', {Password}='${p}')`);
        const res = await fetch(`https://api.airtable.com/v0/${B}/${U}?filterByFormula=${q}`, { headers: {'Authorization':`Bearer ${T}`} });
        const data = await res.json();
        if (data.records && data.records.length > 0) {
            const userData = data.records[0].fields;
            userData.airtableId = data.records[0].id;
            localStorage.setItem('hakaUser', JSON.stringify(userData));
            setupDashboard(userData);
            showPage('dashboard');
        } else alert("Access Denied");
    }

    function setupDashboard(user) {
        document.getElementById('login-page').style.display = 'none';
        document.getElementById('admin-dashboard').style.display = 'flex';
        document.getElementById('adminDisplayName').innerText = user.Name;
        if (user.Role === 'superadmin') {
            document.getElementById('super-menu').style.display = 'block';
            loadActiveAdmins();
        }
        loadData(user.Name);
    }

    async function loadActiveAdmins() {
        const res = await fetch(`https://api.airtable.com/v0/${B}/${U}`, { headers: {'Authorization':`Bearer ${T}`} });
        const data = await res.json();
        const currentUser = JSON.parse(localStorage.getItem('hakaUser'));
        document.getElementById('activeAdminsBody').innerHTML = (data.records || []).map(u => {
            const isSelf = u.id === currentUser.airtableId;
            return `<tr>
                <td>${u.fields.Name} ${isSelf ? '<small>(Me)</small>' : ''}</td>
                <td>${u.fields.Email}</td>
                <td>${u.fields.Role}</td>
                <td>${!isSelf ? `<button class="btn-del" onclick="deleteAdmin('${u.id}')">Delete</button>` : '-'}</td>
            </tr>`;
        }).join('');
    }

    async function deleteAdmin(id) {
        if(confirm("Permanently delete this admin?")) {
            await fetch(`https://api.airtable.com/v0/${B}/${U}/${id}`, { method:'DELETE', headers:{'Authorization':`Bearer ${T}`} });
            loadActiveAdmins();
        }
    }

    async function loadData(adminName) {
        const res = await fetch(`https://api.airtable.com/v0/${B}/${encodeURIComponent(L)}?sort[0][field]=Ticket ID&sort[0][direction]=desc`, { headers: {'Authorization':`Bearer ${T}`} });
        const data = await res.json();
        globalTickets = data.records || [];
        
        const pending = globalTickets.filter(r => r.fields.Status !== 'Done');
        const myDone = globalTickets.filter(r => r.fields.Status === 'Done' && r.fields["Handled By IT"] === adminName);
        const isSuper = JSON.parse(localStorage.getItem('hakaUser')).Role === 'superadmin';

        document.getElementById('count-my-progress').innerText = myDone.length;
        document.getElementById('ticketBody').innerHTML = pending.map(r => `
            <tr>
                <td>#${r.fields["Ticket ID"] || ''}</td>
                <td><b>${r.fields.Company || ''}</b></td>
                <td>${(r.fields.Description||"").substring(0,40)}...</td>
                <td>
                    <button class="btn-act" onclick="openSolve('${r.id}')" style="padding:5px 10px; font-size:11px;">PROCESS</button>
                    ${isSuper ? `<button class="btn-del" onclick="deleteRecord('${r.id}')">DEL</button>` : ''}
                </td>
            </tr>`).join('');
        document.getElementById('myHistoryBody').innerHTML = myDone.map(r => `<tr><td>#${r.fields["Ticket ID"]}</td><td>${r.fields.Company}</td><td>${r.fields["Resolution Note"]||""}</td></tr>`).join('');
        
        renderCharts(globalTickets);
        if(isSuper) loadTeamStats();
    }

    function openSolve(id) {
        const t = globalTickets.find(x => x.id === id).fields;
        document.getElementById('activeRecId').value = id;
        document.getElementById('det-id').innerText = "#" + (t["Ticket ID"] || 'N/A');
        document.getElementById('det-name').innerText = t["Employee Full Name"] || 'N/A';
        document.getElementById('det-desc').innerText = t["Description"] || 'N/A';
        const url = t.Attachment;
        document.getElementById('det-attach').innerHTML = (url && typeof url === 'string') ? 
            `<img src="${url}" onclick="window.open('${url}')">` : "<small style='color:#999'>No External Attachment Link</small>";
        document.getElementById('solveModal').style.display = 'block';
    }

    function viewHistory(name) {
        const solved = globalTickets.filter(t => t.fields["Handled By IT"] === name && t.fields.Status === 'Done');
        document.getElementById('hist-title').innerText = name + "'s Records";
        document.getElementById('hist-list').innerHTML = solved.map(t => {
            const f = t.fields;
            return `
                <div class="hist-card">
                    <div style="display:flex; justify-content:space-between;">
                        <h4 style="margin:0; color:#166e48;">#${f["Ticket ID"]} - ${f.Company}</h4>
                        <button class="btn-del" onclick="deleteRecord('${t.id}')">Remove Log</button>
                    </div>
                    <div style="font-size:12px; margin:5px 0;">Staff: <b>${f["Employee Full Name"]}</b></div>
                    <div class="box-problem"><strong>Problem:</strong><br>${f.Description || 'N/A'}</div>
                    <div class="box-solution"><strong>Solution:</strong><br>${f["Resolution Note"] || 'N/A'}</div>
                </div>`;
        }).join('') || '<p style="text-align:center;">No completed tasks.</p>';
        document.getElementById('historyModal').style.display = 'block';
    }

    function exportToExcel() {
        const data = globalTickets.map(t => ({
            "ID": t.fields["Ticket ID"], "Company": t.fields.Company, "Employee": t.fields["Employee Full Name"],
            "Problem": t.fields.Description, "Solution": t.fields["Resolution Note"], "IT_Admin": t.fields["Handled By IT"], "Status": t.fields.Status
        }));
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "IT_Logs");
        XLSX.writeFile(wb, "HAKA_System_Report.xlsx");
    }

    function exportToPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('l', 'mm', 'a4');
        const rows = globalTickets.map(t => [t.fields["Ticket ID"], t.fields.Company, t.fields["Employee Full Name"], t.fields.Status, t.fields["Handled By IT"]]);
        doc.text("HAKA Group IT Performance Report", 14, 15);
        doc.autoTable({ head: [['ID', 'Company', 'Employee', 'Status', 'Admin']], body: rows, startY: 22, theme: 'grid', headStyles: {fillColor:[22, 110, 72]} });
        doc.save("HAKA_Team_Report.pdf");
    }

    function renderCharts(recs) {
        const counts = {}; recs.forEach(r => { if(r.fields.Company) counts[r.fields.Company] = (counts[r.fields.Company]||0)+1; });
        const ctx = document.getElementById('companyChart').getContext('2d');
        if(charts.c) charts.c.destroy();
        charts.c = new Chart(ctx, { type: 'bar', data: { labels: Object.keys(counts), datasets: [{ label: 'Tickets', data: Object.values(counts), backgroundColor: '#166e48' }] }, options: { maintainAspectRatio: false } });
    }

    async function loadTeamStats() {
        const res = await fetch(`https://api.airtable.com/v0/${B}/${U}`, { headers: {'Authorization':`Bearer ${T}`} });
        const data = await res.json();
        const teamPerf = {};
        document.getElementById('teamBody').innerHTML = (data.records||[]).map(u => {
            const count = globalTickets.filter(t => t.fields["Handled By IT"] === u.fields.Name && t.fields.Status === 'Done').length;
            teamPerf[u.fields.Name] = count;
            return `<tr><td>${u.fields.Name}</td><td>${u.fields.Email}</td><td><b>${count} Solved</b></td><td><button class="btn-act" onclick="viewHistory('${u.fields.Name}')" style="background:#f0f4f3; color:#166e48; padding:5px 10px; font-size:11px;">Details</button></td></tr>`;
        }).join('');
        const ctxT = document.getElementById('teamChart').getContext('2d');
        if(charts.t) charts.t.destroy();
        charts.t = new Chart(ctxT, { type: 'bar', data: { labels: Object.keys(teamPerf), datasets: [{ label: 'Performance', data: Object.values(teamPerf), backgroundColor: '#166e48' }] }, options: { maintainAspectRatio: false } });
    }

    async function submitResolution() {
        const id = document.getElementById('activeRecId').value, user = JSON.parse(localStorage.getItem('hakaUser'));
        const fields = { "Status": document.getElementById('newStatus').value, "Resolution Note": document.getElementById('resDesc').value, "Handled By IT": user.Name };
        await fetch(`https://api.airtable.com/v0/${B}/${encodeURIComponent(L)}/${id}`, { method:'PATCH', headers:{'Authorization':`Bearer ${T}`, 'Content-Type':'application/json'}, body:JSON.stringify({fields}) });
        closeModal(); loadData(user.Name);
    }
    async function deleteRecord(id) { if(confirm("Delete record?")) { await fetch(`https://api.airtable.com/v0/${B}/${encodeURIComponent(L)}/${id}`, { method:'DELETE', headers:{'Authorization':`Bearer ${T}`} }); closeModal(); loadData(JSON.parse(localStorage.getItem('hakaUser')).Name); } }
    async function addNewAdmin() {
        const fields = { "Name": document.getElementById('add-name').value, "Email": document.getElementById('add-email').value, "Password": document.getElementById('add-pass').value, "Role": document.getElementById('add-role').value };
        await fetch(`https://api.airtable.com/v0/${B}/${U}`, { method:'POST', headers:{'Authorization':`Bearer ${T}`, 'Content-Type':'application/json'}, body:JSON.stringify({fields}) });
        alert("Admin added!"); loadActiveAdmins();
    }
    async function handleHandover() {
        const user = JSON.parse(localStorage.getItem('hakaUser')), e = document.getElementById('h-email').value, op = document.getElementById('h-old-pass').value, np = document.getElementById('h-new-pass').value;
        if (e !== user.Email || op !== user.Password) return alert("Verify Error!");
        await fetch(`https://api.airtable.com/v0/${B}/${U}/${user.airtableId}`, { method:'PATCH', headers:{'Authorization':`Bearer ${T}`, 'Content-Type':'application/json'}, body:JSON.stringify({fields:{"Password":np, "Email":e}}) });
        logout();
    }
    function closeModal() { document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); }
    function logout() { localStorage.clear(); sessionStorage.clear(); location.reload(); }
</script>
</body>
</html>
