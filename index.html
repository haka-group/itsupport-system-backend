<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HAKA Group IT - Management Portal</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        :root { --primary: linear-gradient(135deg, #166e48 0%, #0d4d32 100%); --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; overflow: hidden; color: #333; }
        #login-page { display: flex; justify-content: center; align-items: center; height: 100vh; position: fixed; width: 100%; background: var(--bg); z-index: 10000; }
        .login-card { background: #fff; padding: 40px; border-radius: 30px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); width: 350px; text-align: center; }
        #admin-dashboard { display: none; height: 100vh; width: 100%; display: flex; }
        .sidebar { width: 260px; background: #fff; border-right: 1px solid #e0e6e4; display: flex; flex-direction: column; padding: 25px; box-sizing: border-box; }
        .main { flex: 1; padding: 25px; overflow-y: auto; box-sizing: border-box; }
        .nav-item { padding: 12px 15px; margin-bottom: 5px; border-radius: 12px; cursor: pointer; display: flex; align-items: center; gap: 10px; color: #5a6b65; transition: 0.3s; font-weight: 500; }
        .nav-item.active { background: var(--primary); color: #fff; }
        .page-content { display: none; }
        .page-content.active { display: block; }
        .chart-card { background: #fff; padding: 15px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); margin-bottom: 20px; height: 200px; }
        table { width: 100%; border-collapse: collapse; background: #fff; border-radius: 15px; overflow: hidden; }
        th { background: #f8faf9; padding: 12px; text-align: left; color: #889; font-size: 11px; text-transform: uppercase; }
        td { padding: 12px; border-bottom: 1px solid #f1f3f2; font-size: 13px; }
        .modal { display:none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(13, 38, 28, 0.6); z-index:20000; backdrop-filter: blur(8px); }
        .modal-content { background: #fff; margin: 2% auto; width: 750px; border-radius: 25px; overflow: hidden; }
        .modal-header { background: var(--primary); color: white; padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 25px; max-height: 75vh; overflow-y: auto; }
        .box-problem { background: #fff8e1; color: #856404; padding: 15px; border-radius: 10px; margin-top: 10px; font-size: 13px; border: 1px solid #ffeeba; }
        .btn-act { background: var(--primary); color: white; border: none; padding: 10px 18px; border-radius: 10px; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; }
        .btn-del { background: #ffebee; color: #d32f2f; border: none; padding: 6px 12px; border-radius: 8px; cursor: pointer; font-size: 11px; }
    </style>
</head>
<body>

    <div id="login-page">
        <div class="login-card">
            <img src="https://i.postimg.cc/Y98Km4rh/Whats-App-Image-2026-01-22-at-14-13-49.png" width="160">
            <h3>IT Staff Portal</h3>
            <input type="email" id="userEmail" placeholder="Email">
            <input type="password" id="userPass" placeholder="Password">
            <button onclick="handleLogin()" class="btn-act" style="width:100%; margin-top:20px; justify-content:center;">Sign In</button>
        </div>
    </div>

    <div id="admin-dashboard">
        <div class="sidebar">
            <img src="https://i.postimg.cc/Y98Km4rh/Whats-App-Image-2026-01-22-at-14-13-49.png" width="130" style="align-self:center; margin-bottom:35px;">
            <div class="nav-item" id="nav-dashboard" onclick="showPage('dashboard')"><span class="material-icons-outlined">dashboard</span> Dashboard</div>
            <div class="nav-item" id="nav-progress" onclick="showPage('progress')"><span class="material-icons-outlined">trending_up</span> Your Progress</div>
            <div id="super-menu" style="display:none; border-top:1px solid #eee; margin-top:10px; padding-top:10px;">
                <div class="nav-item" id="nav-team" onclick="showPage('team')"><span class="material-icons-outlined">groups</span> Team Monitoring</div>
                <div class="nav-item" id="nav-security" onclick="showPage('security')"><span class="material-icons-outlined">admin_panel_settings</span> Security & Admins</div>
            </div>
            <div onclick="logout()" style="margin-top:auto; color:red; cursor:pointer; padding:10px; display:flex; align-items:center; gap:10px; font-weight:600;"><span class="material-icons-outlined">logout</span> Logout</div>
        </div>

        <div class="main">
            <h3 style="margin-bottom:25px;">Hello, <span id="adminDisplayName" style="color:#166e48;">User</span></h3>

            <div id="dashboard-page" class="page-content">
                <div class="chart-card"><canvas id="companyChart"></canvas></div>
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Company</th>
                            <th>Sent At</th>
                            <th>Summary</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="ticketBody"></tbody>
                </table>
            </div>

            <div id="progress-page" class="page-content">
                <div style="background:#fff; padding:15px; border-radius:15px; border-left:5px solid #166e48; margin-bottom:15px;">
                    Total Solved by You: <b id="count-my-progress">0</b>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Company</th>
                            <th>Sent At</th>
                            <th>Solved At</th>
                            <th>Note</th>
                        </tr>
                    </thead>
                    <tbody id="myHistoryBody"></tbody>
                </table>
            </div>

            <div id="team-page" class="page-content">
                <div style="display: flex; gap: 15px; margin-bottom: 20px; align-items: center; justify-content: space-between;">
                    <h4 style="margin:0;">Team Performance</h4>
                    <div id="export-controls" style="display: flex; gap: 10px;">
                        <button onclick="exportToExcel()" class="btn-act" style="background:#2e7d32; font-size:12px;"><span class="material-icons-outlined">table_view</span> Excel</button>
                        <button onclick="exportToPDF()" class="btn-act" style="background:#c62828; font-size:12px;"><span class="material-icons-outlined">picture_as_pdf</span> PDF</button>
                    </div>
                </div>
                <div class="chart-card"><canvas id="teamChart"></canvas></div>
                <table>
                    <thead><tr><th>Admin Name</th><th>Email</th><th>Solved</th><th>Action</th></tr></thead>
                    <tbody id="teamBody"></tbody>
                </table>
            </div>

            <div id="security-page" class="page-content">
                </div>
        </div>
    </div>

    <div id="solveModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3>Process Ticket</h3><span class="material-icons-outlined" onclick="closeModal()" style="cursor:pointer;">close</span></div>
            <div class="modal-body">
                <div id="det-id-label"></div>
                <div id="det-desc" class="box-problem"></div>
                <input type="hidden" id="activeRecId">
                <select id="newStatus"><option value="Done">Resolved</option><option value="Incomplete">Needs Info</option></select>
                <textarea id="resDesc" rows="3" placeholder="Technical resolution note..."></textarea>
                <button onclick="submitResolution()" class="btn-act" style="width:100%; margin-top:15px; justify-content:center;">Submit Resolution</button>
            </div>
        </div>
    </div>

<script>
    const T = "patSfE4E7BGq95o5V.765ef3c9e82a7fb6fe26152bd2e696c5224ebb2cd0593b1a955b38f9eaf2cad0", B = "appyQQt9Dg0MP0zVK", U = "users", L = "it system 2";
    let charts = {}, globalTickets = [];

    window.onload = () => { 
        const saved = localStorage.getItem('hakaUser'); 
        if(saved) {
            setupDashboard(JSON.parse(saved));
            showPage(sessionStorage.getItem('lastPage') || 'dashboard');
        }
    };

    function showPage(pId) {
        document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById(pId + '-page').classList.add('active');
        document.getElementById('nav-' + pId).classList.add('active');
        sessionStorage.setItem('lastPage', pId);
    }

    async function handleLogin() {
        const e = document.getElementById('userEmail').value, p = document.getElementById('userPass').value;
        const q = encodeURIComponent(`AND({Email}='${e}', {Password}='${p}')`);
        const res = await fetch(`https://api.airtable.com/v0/${B}/${U}?filterByFormula=${q}`, { headers: {'Authorization':`Bearer ${T}`} });
        const data = await res.json();
        if (data.records && data.records.length > 0) {
            const userData = data.records[0].fields;
            userData.airtableId = data.records[0].id;
            localStorage.setItem('hakaUser', JSON.stringify(userData));
            setupDashboard(userData);
            showPage('dashboard');
        } else alert("Access Denied");
    }

    function setupDashboard(user) {
        document.getElementById('login-page').style.display = 'none';
        document.getElementById('admin-dashboard').style.display = 'flex';
        document.getElementById('adminDisplayName').innerText = user.Name;
        if (user.Role === 'superadmin') document.getElementById('super-menu').style.display = 'block';
        loadData(user.Name);
    }

    async function loadData(adminName) {
        const res = await fetch(`https://api.airtable.com/v0/${B}/${encodeURIComponent(L)}?sort[0][field]=Ticket ID&sort[0][direction]=desc`, { headers: {'Authorization':`Bearer ${T}`} });
        const data = await res.json();
        globalTickets = data.records || [];
        
        const pending = globalTickets.filter(r => r.fields.Status !== 'Done');
        const myDone = globalTickets.filter(r => r.fields.Status === 'Done' && r.fields["Handled By IT"] === adminName);
        const isSuper = JSON.parse(localStorage.getItem('hakaUser')).Role === 'superadmin';

        // رسم التذاكر الجديدة مع وقت الإرسال
        document.getElementById('ticketBody').innerHTML = pending.map(r => {
            const sTime = r.fields["Submission Time"] ? new Date(r.fields["Submission Time"]).toLocaleString('en-GB', {hour:'2-digit', minute:'2-digit'}) : 'N/A';
            return `<tr>
                <td>#${r.fields["Ticket ID"] || ''}</td>
                <td><b>${r.fields.Company || ''}</b></td>
                <td style="color:#666; font-size:11px;">${sTime}</td>
                <td>${(r.fields.Description||"").substring(0,30)}...</td>
                <td><button class="btn-act" onclick="openSolve('${r.id}')" style="padding:5px 10px; font-size:11px;">PROCESS</button></td>
            </tr>`;
        }).join('');

        // رسم تاريخ الحل الشخصي مع وقت الإرسال ووقت الحل
        document.getElementById('count-my-progress').innerText = myDone.length;
        document.getElementById('myHistoryBody').innerHTML = myDone.map(r => {
            const sTime = r.fields["Submission Time"] ? new Date(r.fields["Submission Time"]).toLocaleString('en-GB') : 'N/A';
            const rTime = r.fields["Resolution Time"] ? new Date(r.fields["Resolution Time"]).toLocaleString('en-GB') : 'N/A';
            return `<tr>
                <td>#${r.fields["Ticket ID"]}</td>
                <td>${r.fields.Company}</td>
                <td style="font-size:11px;">${sTime}</td>
                <td style="font-size:11px; color:#166e48; font-weight:bold;">${rTime}</td>
                <td>${r.fields["Resolution Note"]||""}</td>
            </tr>`;
        }).join('');
        
        renderCharts(globalTickets);
    }

    function openSolve(id) {
        const t = globalTickets.find(x => x.id === id).fields;
        document.getElementById('activeRecId').value = id;
        document.getElementById('det-id-label').innerHTML = `<b>#${t["Ticket ID"]}</b> - ${t["Employee Full Name"]}`;
        document.getElementById('det-desc').innerText = t["Description"];
        document.getElementById('solveModal').style.display = 'block';
    }

    async function submitResolution() {
        const id = document.getElementById('activeRecId').value;
        const user = JSON.parse(localStorage.getItem('hakaUser'));
        const now = new Date().toISOString(); // تسجيل وقت الحل الآن

        const fields = { 
            "Status": document.getElementById('newStatus').value, 
            "Resolution Note": document.getElementById('resDesc').value, 
            "Handled By IT": user.Name,
            "Resolution Time": now 
        };

        await fetch(`https://api.airtable.com/v0/${B}/${encodeURIComponent(L)}/${id}`, { 
            method:'PATCH', 
            headers:{'Authorization':`Bearer ${T}`, 'Content-Type':'application/json'}, 
            body:JSON.stringify({fields}) 
        });
        alert("Time Logged Successfully!");
        closeModal(); loadData(user.Name);
    }

    function exportToExcel() {
        const data = globalTickets.map(t => ({
            "ID": t.fields["Ticket ID"],
            "Company": t.fields.Company,
            "Submitted At": t.fields["Submission Time"],
            "Resolved At": t.fields["Resolution Time"],
            "Admin": t.fields["Handled By IT"],
            "Status": t.fields.Status
        }));
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Reports");
        XLSX.writeFile(wb, "HAKA_System_Report.xlsx");
    }

    function exportToPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('l', 'mm', 'a4');
        const rows = globalTickets.map(t => [t.fields["Ticket ID"], t.fields.Company, t.fields["Submission Time"], t.fields["Resolution Time"], t.fields.Status]);
        doc.text("HAKA Group - Ticket Performance", 14, 15);
        doc.autoTable({ head: [['ID', 'Company', 'Sent At', 'Solved At', 'Status']], body: rows, startY: 22 });
        doc.save("HAKA_Report.pdf");
    }

    function closeModal() { document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); }
    function logout() { localStorage.clear(); location.reload(); }
</script>
</body>
</html>
